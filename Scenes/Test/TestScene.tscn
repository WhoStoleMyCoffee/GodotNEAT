[gd_scene load_steps=3 format=2]

[ext_resource path="res://NEAT/NEATDisplayer.gd" type="Script" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D


const SAVEPATH : String = 'res://Scenes/Test/nn.json'

var pop : NEATPopulation
var di : int = 0

var X : Array = [
	[0.0, 0.0, 1.0],
	[1.0, 0.0, 1.0],
	[0.0, 1.0, 1.0],
	[1.0, 1.0, 1.0]
]
var y : Array = [
	[0.0],
	[1.0],
	[1.0],
	[1.0]
]


func _ready():
	pop = NEATPopulation.new(20, 3,1)
	pop.TARGET_SPECIES = 6
	
	for g in pop.genomes:
		pop.mutate(g.connect_all_nodes())
	
	ff()
	$NEATDisplayer.set_drawing_nn(pop.genomes[0])
	
	print(pop.genomes.size())
	print(pop.species_data)


func _input(event):
	if Input.is_action_just_pressed(\"ui_right\"):
		di = (di+1) % pop.genomes.size()
		update_display()
	
	if Input.is_action_just_pressed(\"ui_left\"):
		di -= 1
		if di < 0: di = pop.genomes.size()-1
		update_display()
	
	if Input.is_action_just_pressed(\"ui_accept\"):
		di = 0
		print('  reproducing...')
		pop.gen_over()
		
		print(pop.species_data)
		ff()
		update_display()


func update_display():
		$NEATDisplayer.set_drawing_nn(pop.genomes[di])
		$RichTextLabel.text = 'GEN %s' % [pop.gen] \\
			+ '\\n genome %s\\n  species: %s\\n  fitness: %s' % [di, pop.genomes[di].species_id, pop.genomes[di].fitness]


func ff():
	for j in range(pop.size()):
		var g : NEATNN = pop.genomes[j]
		g.fitness = 0.0
		for i in range(4):
			var output : Array = g.feed_forward(X[i])
			var f : float = range_lerp(abs(output[0] - y[i][0]), 0.0, 1.0, 1.0, 0.0)
			g.fitness += f


func _on_Button_pressed():
	var X = [float($in1.pressed), float($in2.pressed), 1.0]
	var y = pop.genomes[di].feed_forward(X)
	$output.text = 'output: %s' % y[0]




func _on_Save_pressed():
	print('Saving genome...')
	pop.genomes[di].save_json(SAVEPATH)
	print('Saving complete')


func _on_Load_pressed():
	print('Loading genome...')
	pop.genomes[di].load_json(SAVEPATH)
	print('Loading complete')
	update_display()
"

[node name="TestScene" type="Node2D"]
script = SubResource( 1 )

[node name="NEATDisplayer" type="ReferenceRect" parent="."]
margin_left = 16.0
margin_top = 16.0
margin_right = 528.0
margin_bottom = 272.0
rect_min_size = Vector2( 512, 256 )
script = ExtResource( 1 )
connection_width = 1.0
do_draw_node_id = true

[node name="RichTextLabel" type="RichTextLabel" parent="."]
margin_left = 21.0
margin_top = 294.0
margin_right = 523.0
margin_bottom = 540.0

[node name="in1" type="CheckButton" parent="."]
margin_left = 617.0
margin_top = 24.0
margin_right = 693.0
margin_bottom = 64.0
focus_mode = 0

[node name="in2" type="CheckButton" parent="."]
margin_left = 693.0
margin_top = 24.0
margin_right = 769.0
margin_bottom = 64.0
focus_mode = 0

[node name="Button" type="Button" parent="."]
margin_left = 630.0
margin_top = 68.0
margin_right = 687.0
margin_bottom = 88.0
focus_mode = 0
text = "test nn"

[node name="output" type="Label" parent="."]
margin_left = 628.0
margin_top = 104.0
margin_right = 668.0
margin_bottom = 118.0

[node name="Save" type="Button" parent="."]
margin_left = 542.0
margin_top = 252.0
margin_right = 667.0
margin_bottom = 272.0
text = "Save this genome"

[node name="Load" type="Button" parent="."]
margin_left = 542.0
margin_top = 276.0
margin_right = 667.0
margin_bottom = 296.0
text = "Load genome"

[connection signal="pressed" from="Button" to="." method="_on_Button_pressed"]
[connection signal="pressed" from="Save" to="." method="_on_Save_pressed"]
[connection signal="pressed" from="Load" to="." method="_on_Load_pressed"]
